
# Thermodynamic Integration Workflow to compute the free energy of different phases

The Thermodynamic Integration (TI) Workflow is designed to compute the free energy of various phases. 

The main script, `main_<MHP>.py`, orchestrates the workflow, executing simulations and conducting part of the post-analysis for the specified MHP. It requires an initial structure and a MACE MLP located in the **data** subfolder. The workflow leverages Python scripts from the **lib** subfolder and utilizes Parsl to manage tasks across different resources, as defined by a configuration file in the **configs** subfolder. The calculations were performed on the VSC Hortense HPC, necessitating the use of the `vsc_hortense.py` file to configure executors. Due to issues with task distribution across cores, jobs were managed using rankfiles located in the **configs/rankfiles** subfolder. The `lib/bash_app_python.py` script facilitated the assignment of the appropriate rankfile to each task.

For each material and phase, workflows are defined in the `lib/Workflow_class.py` script. Each workflow comprises various simulations outlined in the `Simulation_class` script, which utilizes `papps.py` (containing Python apps) to set simulation inputs based on prior outputs and to conduct post-analysis. The `Free_energy_classes.py` script plays a crucial role in defining and calculating the different free energy contributions (fec) based on simulation outputs. Additionally, methods for executing simulations are specified in `run_papps.py`, while `utils.py` contains utility functions used throughout the workflow. The `DefineCV.py` script defines the collective variables used to bias the FA and MA organic molecules. Although `ExtendedHessianOutput.py` (for constructing a harmonic PES for a NequIP MLP) and `RectMCbarostat.py` (for utilizing the MC barostat in NPT MD simulations) were tested, they were not included in the final workflow.

The workflow automatically generates free energy contributions (fec) for each simulation and assesses the convergence of these contributions through relevant plots (refer to SI Sec. S5 of the paper). Output files are organized in the **output_and_post_analysis** folder, which contains subfolders for each material and phase. Additional post-analysis scripts are also available in this folder, typically combining and comparing different fecs to produce the plots presented in the paper and supplementary information. The comparison of fecs across phases for each MHP is located in the respective MHP subfolder, which includes the **Plots/fec** subfolder. The **Plots/opt** folder for each MHP contains comparisons of optimized energies and phonon spectra for the 8 and 64 formula unit simulation cells. The **Plots/orient** folder in the FAPbI3 and MAPbI3 directories displays the distribution of FA and MA orientations under varying conditions. Lastly, the **contrib_plots** folder provides comparisons of different fecs across MHPs.

It is important to note that these scripts are currently outdated, as they depend on YAFF, which is no longer adequately supported, and an older version of Parsl. Consequently, we have rewritten these scripts in a new software package called Thermoflow (currently a private GitHub repository, available upon request). Thermoflow is built on top of PsiFlow (https://github.com/molmod/psiflow), which is actively maintained by our group. For MD simulations, Thermoflow employs i-PI instead of YAFF in conjunction with MACE MLPs.
